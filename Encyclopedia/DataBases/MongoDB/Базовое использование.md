# Базовое использоавние MongoDB

## Библиотеки
Для работы с Mongo используют две библиотеки. Обе очень современные и к тому же от разработчиков самой MongoDB.
Поэтому обе красивые, лаконичные и понятные

1) Синхронная `pymongo`
```
pip install pymongo
```
2) Асинхронная `motor`
```
pip install motor
```

<hr>

## Подключение к БД из кода

#### Импортируем библиотеку

```python
import pymongo
```
#### Устанавливаем соединение с Mongo сервером

```python
client = pymongo.MongoClient('localhost', port=27017)
```
Если сервер удалённый, то вводите ip сервера и порт, на котором запущена Mongo

#### Устанавливаем соединение с базой данных на сервере
```python
db = client['my_telegram_bot']
```

Да, соединение устанавливается так, будто вы берёте что то по ключу из словаря!
Ключом должно быть название вашей базы данных, которую вы создали через `Compass` ранее

**Учтите** - это переменная через которую происходит **Подключение** к БД. Как объект `session` в `requests`

#### Устанавливаем соединение с самой коллекцией
```python
users_collection = db['users']
```
Здесь тоже соединение устанавливается так, будто вы берёте что то по ключу из словаря
Ключом должно быть название коллекции данных, которую вы создали через `Compass` ранее

#### Итоговый код будет выглядет примерно так

```python
import pymongo

client = pymongo.MongoClient('localhost', port=27017)
db = client['my_telegram_bot']
users_collection = db['users']

# Ниже можно добавлять новые подключения к коллекциям
# Без повторноо создания переменных client и db
managers_collection = db['managers']
# ....
```

<hr>

## Добавление записей
### Добавить новую запись в коллекцию
```
collection.insert(new_dictionary)
```
Например:
```python
users_collection.insert_one({'name': 'ProKing2020', 'age': 5})
```

### Добавить несколько новых записей в коллекцию
```
collection.insert(new_dictionary)
```
Например:
```python
users_collection.insert_many([{'name': 'Nas565', 'age': 5}, {'name': 'Den000', 'age': 15}])
```

## Получение записей
### Получить одну запись из коллекции
```
x = collection.find(filter)
```
Например:
```python
looking_user = users_collection.find_one(filter={'name': 'ProKing2020'})
```

Этот код найдет в коллекции `users` пользователя с именем `MinecraftKing2020`
**Если в коллекции несколько пользователей с таким именем, он найдёт первого**

Вы заметите, что у словаря есть один дополнительный ключ `_id` - это системный ключ Mongo. Он добавляется к каждой записи


### Получить много записей из коллекции
```
x = collection.find(filter)
```
Например:
```python
looking_users = users_collection.find(filter={'age': 5}).to_list()
```

Этот код найдет в коллекции `users` всех пользователей с возрастом 5

`.to_list()` на конце означает, что мы хотим преобразовать ответ сервера в `список`
Если его не добавлять, то в переменной `looking_users` будет объект `курсор`. Всё что с ним можно сделать - пробежать по нему циклом. 
Это удобно, если пользователей в базе данных очень много - это сокращает потребление оперативной памяти и работает быстрее, чем преобразование сразу в список


## Фильтрация по нескольим ключам

Можно добавить несколько ключей для фильтрации
Например:
```python
looking_users = users_collection.find(filter={'age': 5, 'city': 'Moscow'}).to_list()
```

Данный код найдет всех пользователей, которым 5 лет и которые живут в Москве

## Удаление записей
### Удаление одной записи
```
collection.delete_one(filter)
```
Например:
```python
users_collection.delete_one(filter={'age': 5})
```
Данный код удалит пользователя с возрастом 5
**Если в коллекции несколько пользователей с таким именем, он удалит первого из них**

### Удаление нескольких записей
```
collection.delete_many(filter)
```
Например:
```python
users_collection.delete_many(filter={'city': 'Moscow'})
```
Данный код удалит всех пользователей, у которых город 'Moscow'


## Обновление записей
### Обновление одной записи
```
collection.update_one(filter, update)
```
Например:
```python
users_collection.update_one(filter={'name': 'ProKing2020'}, update={'$set' : {'game': 'Minecraft'}})
```
Данный код задаст (`$set`) `game` на `Minecraft` у пользователя с именем `ProKing2020`
**Если в коллекции несколько пользователей с таким именем, он изменит самого первого**
**Если у пользователя не было ранее такого ключа, он автоматически создастся**


### Обновление нескольких записей
```
collection.update_many(filter, update)
```
Например:
```python
users_collection.update_one(filter={'city': 'Moscow'}, update={'$set' : {'drink': 'coffee', 'food': 'rolls'}})
```
Данный код задаст (`$set`) `drink` на `coffee` и `food` на `rolls` у всех пользователей с в городе `Moscow`

**Если у кого то из пользователей не было ранее таких ключей или ключа, он автоматически создастся**