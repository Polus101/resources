## Подводные камни FSM
### Важно для тех, кто хочет писать серьезных ботов
Как говорилось выше, `FSM` - просто переменная в коде. А значит, она неизбежно сбрасывается после перезапуска бота. Отсюда один главный недостаток - **использование FSM может быть небезопасным**

Если вы хотите, например, обновить бота на новую версию, Вам в любом случае необходимо его перезапустить. Если хотите баг исправить, если сервер, на котором располагается бот, лег на 5 минут, если технические работы на сервере и т.д. Есть множесто ситуация, когда придется ненадолго остановить бота
Что если в этот момент кто то из пользователей что то последовательно вводит? **Весь его прогресс сбросится**

А если он вводит данные для оплаты? Или `state` должен отслеживать процесс этой самой оплаты?

Пусть, оплату можно настроить и без использования состояний, **но даже с неважными** последовательными вводами есть беды для пользователя

**Рассмотрите несколько схем:**

<p align="center">
<img src="https://github.com/Polus101/resources/blob/master/Encyclopedia/Telegram_Bots/img/error_1.png" style="width:60%"/>
</p>

- Бот по какой то причине остановился после сохранения данных в бд. 
- Сброс `state` и вывод сообщения об успешной регистрации c кнопками главного меню пользователю не сработали (`state` все равно обнулится при повторном запуске)

Когда бот снова будет запущен, пользователь не поймет, пройдена ли регистрация, а кнопки главного меню для него так и не появятся. 
Более того, пользователь даже не узнает, когда именно бот снова начнет работать - ведь для него бот так и останется пустым, пока он снова не пропишет `/start` (хотя этого можно избежать, если оповещать всех пользователей о старте бота)

<hr></hr>

<p align="center">
<img src="https://github.com/Polus101/resources/blob/master/Encyclopedia/Telegram_Bots/img/error_2.png" style="width:60%"/>
</p>

Если бот остановится между сбросом `state` и выводом сообщения ситуация будет идентичная (так как `state` все равно обнулится при повторном запуске - эта сточка здесь не играет роли)

Окей, кажется, будто проблема решается, если поменять местами сохранение данных в БД и вывод сообщения с клавиатурой

<hr></hr>

<p align="center">
<img src="https://github.com/Polus101/resources/blob/master/Encyclopedia/Telegram_Bots/img/error_3.png" style="width:60%"/>
</p>


Однако тогда ситуация станет еще хуже. В прошлом примере пользователь мог додуматься снова ввести `/start`, а тут:
- Бот по какой то причине остановился после вывода сообщения пользователю об успешной регистрации с кнопками главного меню. 
- Сброс `state` не принципиален (`state` все равно обнулится при повторном запуске)
- Сохранение данных об имени в БД не сработало

Когда бот снова будет запущен, перед пользователем будет продолжать висеть главное меню и сообщение об успешной регистрации. 
Однако пользоваться ботом он не сможет - в БД нет записи об этом пользователе. БОльшая часть функций отвалится, либо будет работать некорректно, так как завязаны на БД


### Очевидное решение
**Не пользоваться `FSM` в важных боевых ботах.** 
Для хранения информации о состоянии пользователя можно использовать БД. Алгоритм работы хэндлеров будет точно **такой же**
Только фильтры станут чуть больше (но это зависит от выбранной БД)

А внутрення работа в хэндлере будет выглядеть следующим образом:

<p align="center">
<img src="https://github.com/Polus101/resources/blob/master/Encyclopedia/Telegram_Bots/img/error_4.png" style="width:60%"/>
</p>

Теперь, состояние пользователя будет храниться в БД, а **(запись данных в бд и обнуление state - последнее действие в функции)** При возникновении сбоя, после запуска бота мы получим на первый взгляд ужасную ситуацию:
- Сообщение отправлено, главное меню появилось
- State в БД все еще стоит на ожидание имени
- Данных об имени в БД нет

Пользователь думает, что регистрация завершена, видит главное меню. Но пользоваться ботом не может, так как бот думает, что следующее действие пользователя - ввод имени

#### Но теперь есть контроль
- Мы можем дополнительно первым делом в функции хэндлер поставить состояние `в процессе обработки введенного имени`
- И первым делом при старте бота "вручную" дообработать функции, которые оборвались на середине из за сбоя

Тогда схема будет следующая:

<p align="center">
<img src="https://github.com/Polus101/resources/blob/master/Encyclopedia/Telegram_Bots/img/error_5.png" style="width:80%"/>
</p>

При таком подходе в худшем случае после сбоя пользователь просто получит дубликат сообщения `"Регистрация завершена"` и увидит все те же кнопки главного меню

**P.S. реальный код будет сильно разниться в зависимости от выбранной БД и названий состояний**, но общая суть останется прежней

