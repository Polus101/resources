# Стабилизация работы Selenium
Selenium в отличии от предыдущих технологий, с которыми мы работали, не очень стабилен. Раньше для запуска вашей программы на другом компьютере было необходимо установить Python и библиотеки нужных версий из файла requirements, который вы создавали.

C Selenium все немного сложнее. Это автоматизация браузера. Однако, Selenium хорошо работает не со всеми версиями Chrome, Selenium может не найти драйвер на компьютере, Selenium может найти не тот драйвер (если у вас установлено несоклько браузеров, основанных на Chrome), Selenium может запустить нужный драйвер, но он не будет иметь доступа ко всем фукнкциям и т.д.

**Так же стоит учитывать, что используемый Selenium драйвер должен соответствовать драйверу, который использует обычный браузер**

Это все решается, хоть и придется немного покопаться

## Содержание
- [Стабилизация версии драйвера](#drivers)
- [Опции запуска](#options)
- [Антибот проверки](#antibot)


<a name="drivers"><h2>Стабилизация версии драйвера</h2></a>

Чтобы Selenium точно находил нужный нам драйвер, нужной версии, которая точно хорошо подходит для автоматизации, можно воспользоваться библиотекой `webdriver_manager`. Она является дополнением к библиотеке Selenium. Хотя, вы конечно, можете использовать ее и отдельно, если придумаете, для чего...

Библиотека позволяет управлять версиями веб драйверов. Она более точно находит драйвер на компьютере, узнает его версию, и сама скачивает для Selenium'а необходимую версию драйвера, подходящую для автоматизации установленного на компьютере браузера

Библиотеку необходимо скачать:
```
pip install webdriver_manager
```

И импортировать:

Для Хром
```python
from webdriver_manager.chrome import ChromeDriverManager
```
Для Мозилы 
```python
from webdriver_manager.firefox import GeckoDriverManager
```

Так же для указания определенной версии драйвера, которую будет использовать Selenium, необходимо импортировать объект `Service`:
```python
from selenium.webdriver.chrome.service import Service
```

После **перед запуском драйвера** добавляем строку:
```python
service = Service(ChromeDriverManager().install())
```

Объект `Service` нужен для указания определенного драйвера, используемого Selenium. А `ChromeDriverManager().install()` найдет последнюю установленную на компьютере версию драйвера для браузера и скачает соответстующую версию веб драйвера для Selenium, поддерживающую все фукнции автоматизации

После строчку, которая запускала драйвер и сохраняла его в переменную driver, дополняем аргументом с указанием нашей переменной `service`:
```python
driver = webdriver.Chrome(service=service)
```

Теперь перед запуском драйвера программа будет проверять и при необходимости устанавливать подходящую версию драйвера

### В дополнение
В зависимости от версии драйвера сайты немного по разному отображаются, хотя обычному пользователю это и незаметно. Иногда случаются ситуации, когда необходимо использовать определенную версию драйвера, так как только на нем страница отображается наиболее удобным для автоматизации образом.

В таком случае, нам придется удалить браузер хром с компьютера (и сервера) и установить его заново, но определенной версии. А в коде явно указать номер версии, которую будет скачивать `webdriver_manager`:

```python
service = Service(ChromeDriverManager(driver_version="107.0.5304.88").install())
```
(Версия `"107.0.5304.88"` указана для примера)

Удалять и скачивать заново браузер нужной версии не очень то удобно. Поэтому, если планируется, что программа будет работать на Windows, вы можете скачать и установить прямо в папку проекта portable версию браузера хром. То-есть она установится прямо в папку проекта и использоваться будет только внутри проекта. 

**Однако, такие версии неофициальны, поэтому неисключена возможность содержания в них вредоносного кода, и скачивать их вам придется на свой страх и риск**

Если все же до этого дошло, то после установки такой версии в папку проекта, будет необходимо, как описывалось выше, указать точную версию данного бразуреа (а значит, и его драйвера)

Так же придется указать определенные опции запуска (настройки). Подробнее о них так же будет ниже

```python
from selenium.webdriver.chrome.options import Options

chrome_options = Options()
chrome_options.binary_location = './GoogleChromePortable/GoogleChromePortable.exe'
```
**Альтеранативный метод импортирования представлен в разделе Антибот проверки**

В `chrome_options.binary_location` необходимо указать путь до запускаемого `.exe` файла установленной вами в папку проекта portable версии

Помимо прочего, дополняем аргументом `options` строчку запуска драйвера:
```python
driver = webdriver.Chrome(service=service, options=chrome_options)
```

<a name="options"><h2>Опции запуска</h2></a>
Опции (настройки) запуска нашего драйвера - важная вещь, без которой не обойдется ни один реальный проект.
Возможно, вы уже стокнулись с проблемами, когда пробовали код из статьи по базовому использованию Selenium. Часть из них решается версией драйвера, а часть опциями запуска

Опций запуска великое множество, но полезных для нас будет лишь 10-20 из них

Для использования опций, нобходимо импортировать объект из библиотеки и создать переменную `chrome_options`:

```python
from selenium.webdriver.chrome.options import Options

chrome_options = Options()
```
Или 
```python
from selenium import webdriver

chrome_options = webdriver.ChromeOptions()
```

После создания переменной, в которой будут храниться опции (настройки) запуска, можно добавить какую нибудь опцию с помощью метода `add_argument`:
```python
chrome_options.add_argument("Ваша добавляемая настройка запуска")
```
Для каждой новой опции будет новый вызом метода `add_argument`. Тоесть для каждой новой опции будет новая строчка `chrome_options.add_argument("Ваша добавляемая настройка запуска")`

И дополняем аргументом `options` строчку запуска драйвера:
```python
driver = webdriver.Chrome(service=service, options=chrome_options)
```

### Наиболее используемые опции запуска для Selenium:
- `--disable-extensions` - отключает все расширения, чтобы они вдруг не подцепились из основного браузера (добавлять лучше всегда, если для вашей автоматизации расширения не требуются)
- `--disable-infobars` - убирает плашку об "использовании автоматического ПО для работы браузера" на некоторых версиях
- На некоторых версиях (более новых) для того, чтобы убрать плашку об "использовании автоматического ПО для работы браузера" придется использовать `experimental_option`
```python
options.add_experimental_option("excludeSwitches", ["enable-automation"])
options.add_experimental_option('useAutomationExtension', False)
```
- Еще одна из `experimental_option`:
```python
chrome_options.add_experimental_option('excludeSwitches', ['enable-logging'])
```
Добавляет в консоль разработчика браузера логи всех уровней. Удобно для отладки, если на каком то сайте не работают какие то функции
- `--headless=new` - запуск браузера без окна (удобно, если необходимо запускать сразу много окон браузера, а нагружать систему не хочется)
- `--remote-debugging-port=9222` - этот флаг добавляет дебаг порт для удаленного подключения. Иногда спасает от некоторых ошибок Selenium
- `'--ignore-ssl-errors'` - игнорирование ssl сертификатов. Сейчас многие сайты начинают работать на государственных ssl сертификатах безопасности, которых, разумеется, нет в открытых международных базах, которые использует Selenium
- `--ignore-certificate-errors` - игнорирование ошибок остальных сертификатов безопасности
- `'--ignore--errors'` - игнорирование ssl сертификатов. Сейчас многие сайты начинают работать на государственных ssl сертификатах безопасности, которых, разумеется, нет в открытых международных базах, которые использует Selenium
- `--disable-blink-features=AutomationControlled` - один из флагов по которому сайты определяют, управляет ли браузером бот или это реальный браузер. Этот флаг контролирует несколько других, поэтоу используйте с осторожностью и только если остальные опции запуска не дали вам нужного результата.
- Небольшой скрипт на замену `--disable-blink-features`:

После создания переменной `driver`, выполните с помощью нее js скприт: 
```python
driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
```
Эффект почти такой же, как от добавления опции `--disable-blink-features=AutomationControlled`. Однако, этот скрипт не затрагивает других флагов запуска, а значит, не ломает ваши настройки, в отличии от опции `disable-blink-features`

---

Это основные опции запуска, которых вам для начала должно хватить. Еще несколько опций, позволяющих работать с пользовательскими данными будут указаны в дальнейших статьях. 

Так же, если у вас возникла специфическая ошибка на сервере или ПК, которая не исправляется одной или несколькими указанными выше опциями, попробуйте найти подходящую опцию в интернете и сообщите преподавателю



<a name="antibot"><h2>Антибот проверки</h2></a>
Если вы пробовали заходить с помощью запущенного драйвера на разные сайты, наверняка вы замечали, что некоторые сайты постоянно запрашивают капчу, а некоторые и вовсе не пускают

Это происходит из за того, что сайты видят, что вы используете автоматизацию браузера (Selenium) и распознают вас как бота. Нечто похожее было и при использовании  `bs4`. Там это базово решалось добавлением `user-agent` к запросу на сайт.

Но у нас не простой запрос, поэтому только этим мы не отделаемся

### Проверка анонимности браузера

Прежде чем писать основной код программы - парсера, убедитесь в том, что запущенный Selenium драйвер (браузер) проходит все требования по антидетекту ботов. Это можно сделать на сайтах:
- [sannysoft](https://bot.sannysoft.com)
- [browserscan](https://browserscan.net/)

Все или хотя бы (90%) показателей должны быть зелеными

### Как обойти проверку
Помимо представленных выше опций запуска, некоторые из которых позволяют обойти антибот проверки, есть так же дополнительная библиотека, которая позволяет сделать Selenium driver максимально напоминающим реальный браузер. Библиотека `selenium_stealth`

Ее необходимо скачать и установить:
```python
pip install selenium_stealth
```
И импортировать:
```python
from selenium_stealth import stealth
```

Далее необходимо вызвать функцию `slealth` и передать ей аргументом наш `driver`. Учтите, что функция ничего не возвращает, поэтоу сохранять ее результат в переменную не нужно. Функция делает изменения в нашей переменной `driver`:
```python
stealth(driver,
        languages=["en-US", "en"],
        vendor="Google Inc.",
        platform="Win64",
        webgl_vendor="Intel Inc.",
        renderer="Intel Iris OpenGL Engine",
        fix_hairline=True,
        )
```
platform, webgl_vendor и renderer можете указать другие настройки, но необязательно



